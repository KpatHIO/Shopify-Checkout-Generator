<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopify Checkout Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h2 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="number"] {
      padding: 8px;
      margin: 4px 0 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      padding: 10px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    button:hover {
      background-color: #45a049;
    }
    #permalink {
      margin-top: 20px;
      font-weight: bold;
      word-wrap: break-word;
    }
    .product-input {
      margin-bottom: 16px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    #addProductButton {
      background-color: #008CBA;
    }
    #addProductButton:hover {
      background-color: #007BB5;
    }
    .section-title {
      margin-top: 20px;
      font-size: 1.05rem;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .hint {
      font-size: 0.8rem;
      color: #666;
      margin-top: -6px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Shopify Checkout Generator</h2>
    <form id="permalinkForm">
      <div id="productInputContainer">
        <div class="product-input">
          <label for="productUrl1">Product 1 URL:</label>
          <input type="text" id="productUrl1" placeholder="Paste Shopify product URL with ?variant=..." required>

          <label for="quantity1">Quantity:</label>
          <input type="number" id="quantity1" min="1" value="1" required>
        </div>
      </div>

      <button type="button" id="addProductButton">Add Another Product</button>

      <div class="section-title">Pickup / Collection</div>
      <div class="checkbox-row">
        <input type="checkbox" id="includeCollection">
        <label for="includeCollection" style="margin-top:0;font-weight:normal;">
          Include <strong>Customer Collection</strong> product (variant ID <code>61962582720671</code>)
        </label>
      </div>

      <div class="section-title">Optional: Discount</div>
      <label for="discountCode">Discount Code:</label>
      <input type="text" id="discountCode">

      <div class="section-title">Optional: Shipping Address</div>

      <!-- Google Maps / Places lookup bar -->
      <label for="autocompleteAddress">Search Address (Google Maps):</label>
      <input type="text" id="autocompleteAddress" placeholder="Start typing address...">
      <div class="hint">Select an address from the dropdown – fields below will auto-fill.</div>

      <label for="firstName">First Name:</label>
      <input type="text" id="firstName">

      <label for="lastName">Last Name:</label>
      <input type="text" id="lastName">

      <label for="address1">Address Line 1:</label>
      <input type="text" id="address1">

      <label for="city">City:</label>
      <input type="text" id="city">

      <label for="province">State / Province:</label>
      <input type="text" id="province">

      <label for="zip">Postcode:</label>
      <input type="text" id="zip">

      <label for="country">Country Code:</label>
      <input type="text" id="country">

      <div class="button-container">
        <button type="submit">Generate Checkout Link</button>
        <button type="button" id="copyButton" style="display:none;">Copy Link</button>
      </div>
    </form>

    <div id="permalink"></div>
  </div>

  <script>
    let productCount = 1;
    const collectionVariantId = '61962582720671';
    let autocomplete; // Google Places Autocomplete instance

    // Initialise Google Places autocomplete on the address search field
    function initAutocomplete() {
      const input = document.getElementById('autocompleteAddress');
      if (!input || !window.google || !google.maps || !google.maps.places) return;

      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['geocode'],
        // limit to Australia – remove or change if you want other countries
        componentRestrictions: { country: ['au'] }
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place || !place.address_components) return;

        const components = {};
        place.address_components.forEach(c => {
          c.types.forEach(t => {
            components[t] = c.long_name;
            components[t + '_short'] = c.short_name;
          });
        });

        const streetNumber = components.street_number || '';
        const route = components.route || '';
        const locality = components.locality || components.sublocality || '';
        const stateShort = components.administrative_area_level_1_short || components.administrative_area_level_1 || '';
        const postCode = components.postal_code || '';
        const countryShort = components.country_short || components.country || '';

        document.getElementById('address1').value = (streetNumber + ' ' + route).trim();
        document.getElementById('city').value = locality;
        document.getElementById('province').value = stateShort;
        document.getElementById('zip').value = postCode;
        document.getElementById('country').value = countryShort;
      });
    }

    document.getElementById('addProductButton').addEventListener('click', function() {
      productCount++;
      const productInputContainer = document.getElementById('productInputContainer');
      const newProductInput = document.createElement('div');
      newProductInput.classList.add('product-input');
      newProductInput.innerHTML = `
        <label for="productUrl${productCount}">Product ${productCount} URL:</label>
        <input type="text" id="productUrl${productCount}" placeholder="Paste Shopify product URL with ?variant=..." required>
        <label for="quantity${productCount}">Quantity:</label>
        <input type="number" id="quantity${productCount}" min="1" value="1" required>
      `;
      productInputContainer.appendChild(newProductInput);
    });

    document.getElementById('permalinkForm').addEventListener('submit', function(event) {
      event.preventDefault();
      let cartPermalink = '';
      let allValid = true;

      // Build cart variant list
      for (let i = 1; i <= productCount; i++) {
        const productUrl = document.getElementById(`productUrl${i}`).value.trim();
        const quantity = document.getElementById(`quantity${i}`).value.trim();

        let variantId;
        try {
          const url = new URL(productUrl);
          variantId = url.searchParams.get('variant');
        } catch {
          alert(`Invalid URL for Product ${i}`);
          allValid = false;
          break;
        }

        if (variantId && quantity) {
          cartPermalink += (cartPermalink ? ',' : '') + `${variantId}:${quantity}`;
        } else {
          alert(`Invalid product or missing variant for Product ${i}`);
          allValid = false;
          break;
        }
      }
      if (!allValid) return;

      // Include collection item
      if (document.getElementById('includeCollection').checked) {
        cartPermalink += (cartPermalink ? ',' : '') + `${collectionVariantId}:1`;
      }

      const firstUrl = new URL(document.getElementById('productUrl1').value.trim());
      const shopUrl = firstUrl.host;
      let finalPermalink = `https://${shopUrl}/cart/${cartPermalink}`;

      // Build optional query parameters
      const q = [];
      const fields = [
        ['first_name', 'firstName'],
        ['last_name', 'lastName'],
        ['address1', 'address1'],
        ['city', 'city'],
        ['province', 'province'],
        ['zip', 'zip'],
        ['country', 'country']
      ];

      fields.forEach(([param, id]) => {
        const v = document.getElementById(id).value.trim();
        if (v) q.push(`checkout[shipping_address][${param}]=${encodeURIComponent(v)}`);
      });

      const discount = document.getElementById('discountCode').value.trim();
      if (discount) q.push(`discount=${encodeURIComponent(discount)}`);

      if (q.length > 0) finalPermalink += '?' + q.join('&');

      document.getElementById('permalink').textContent = `Generated Checkout Link: ${finalPermalink}`;

      const copyButton = document.getElementById('copyButton');
      copyButton.style.display = 'inline-block';
      copyButton.onclick = () => navigator.clipboard.writeText(finalPermalink);
    });
  </script>

  <!-- Google Maps JavaScript API with Places library -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhPPxevVjH9zezfIPpSlrgT2fLpgjgeXI&libraries=places&callback=initAutocomplete" async defer></script>
</body>
</html>
